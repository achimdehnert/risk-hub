# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  RISK-HUB CI/CD — Using Platform Reusable Workflows                      ║
# ║  Migrated from: docker-build.yml (build-only)                            ║
# ║  ADR: ADR-021 Unified Deployment Pattern                                 ║
# ║  ADR-042: Build+Deploy only on workflow_dispatch (not on push)           ║
# ╚═══════════════════════════════════════════════════════════════════════════╝

name: CI/CD Pipeline

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency only)'
        required: false
        default: false
        type: boolean

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # STAGE 1: CI (Lint, Test, Security Scan)
  # ═══════════════════════════════════════════════════════════════════════════
  ci:
    name: "CI"
    uses: achimdehnert/platform/.github/workflows/_ci-python.yml@v1
    with:
      python_version: "3.12"
      coverage_threshold: 0
      requirements_file: "requirements.txt"
      source_dir: "src"
      django_settings_module: "config.settings"
      skip_tests: ${{ inputs.skip_tests || false }}
    secrets: inherit

  # ═══════════════════════════════════════════════════════════════════════════
  # STAGE 2: Build Docker Image
  # ADR-042: Only on workflow_dispatch (CLI or safety-net), not on push
  # ═══════════════════════════════════════════════════════════════════════════
  build:
    name: "Build"
    needs: [ci]
    if: github.event_name == 'workflow_dispatch'
    uses: achimdehnert/platform/.github/workflows/_build-docker.yml@v1
    with:
      dockerfile: "docker/app/Dockerfile"
      scan_image: true
    secrets: inherit

  # ═══════════════════════════════════════════════════════════════════════════
  # STAGE 3: Deploy to Hetzner
  # ═══════════════════════════════════════════════════════════════════════════
  deploy:
    name: "Deploy"
    needs: [build]
    if: github.event_name == 'workflow_dispatch'
    uses: achimdehnert/platform/.github/workflows/_deploy-hetzner.yml@v1
    with:
      app_name: risk-hub
      deploy_path: /opt/risk-hub
      health_url: https://demo.schutztat.de/livez/
      compose_file: docker-compose.prod.yml
      web_service: risk-hub-web
      run_migrations: true
      enable_rollback: true
      notify_slack: false
    secrets:
      HETZNER_HOST: ${{ secrets.DEPLOY_HOST }}
      HETZNER_USER: ${{ secrets.DEPLOY_USER }}
      HETZNER_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
