{% extends "base.html" %}
{% load dsb_components %}
{% block title %}Datenschutz — Schutztat{% endblock %}

{% block content %}
<div class="mb-6" data-testid="dsb-dashboard-header">
    <h1 class="text-2xl font-bold text-gray-900" data-testid="dsb-dashboard-title">
        <i data-lucide="shield" class="w-7 h-7 inline text-blue-600 mr-1"></i>
        Datenschutz-Dashboard
    </h1>
    <p class="text-sm text-gray-500 mt-1">
        DSB-Modul — Übersicht aller datenschutzrelevanten Kennzahlen
    </p>
</div>

{% if kpis.mandates_total %}
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <div class="flex items-center gap-2">
        <i data-lucide="building-2" class="w-5 h-5 text-blue-600"></i>
        <span class="text-sm font-medium text-blue-900">
            {{ kpis.mandates_active }} von {{ kpis.mandates_total }}
            Mandat{{ kpis.mandates_total|pluralize:"en" }} aktiv
        </span>
    </div>
</div>
{% endif %}

{% if kpis.breaches_overdue or kpis.findings_critical or kpis.deletions_pending %}
<div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6"
     data-testid="dsb-alert-banner">
    <h3 class="text-sm font-semibold text-red-800 mb-2">
        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
        Handlungsbedarf
    </h3>
    <ul class="text-sm text-red-700 space-y-1">
        {% if kpis.breaches_overdue %}
        <li>{{ kpis.breaches_overdue }} Datenpanne{{ kpis.breaches_overdue|pluralize:"n" }} — 72h-Frist überschritten!</li>
        {% endif %}
        {% if kpis.findings_critical %}
        <li>{{ kpis.findings_critical }} kritische Audit-Befunde offen</li>
        {% endif %}
        {% if kpis.deletions_pending %}
        <li>{{ kpis.deletions_pending }} Löschung{{ kpis.deletions_pending|pluralize:"en" }} ausstehend</li>
        {% endif %}
    </ul>
</div>
{% endif %}

{% if open_breaches or open_deletions %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">

    {% if open_breaches %}
    <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
            <i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i>
            Offene Datenpannen
            <span class="ml-auto text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">{{ open_breaches|length }}</span>
        </h3>
        <ul class="space-y-2">
            {% for b in open_breaches %}
            <li class="flex items-center justify-between text-sm">
                <a href="{% url 'dsb:breach-detail' b.pk %}" class="text-blue-600 hover:underline truncate flex-1">
                    {{ b.title|default:"Datenpanne" }}
                </a>
                <span class="ml-2 flex-shrink-0 text-xs px-1.5 py-0.5 rounded
                    {% if b.is_overdue %}bg-red-100 text-red-700
                    {% else %}bg-amber-100 text-amber-700{% endif %}">
                    {{ b.get_workflow_status_display }}
                </span>
            </li>
            {% endfor %}
        </ul>
        <a href="{% url 'dsb:breach-list' %}" class="text-xs text-gray-400 hover:text-blue-600 mt-3 block">Alle anzeigen →</a>
    </div>
    {% endif %}

    {% if open_deletions %}
    <div class="bg-white rounded-lg shadow p-4">
        <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
            <i data-lucide="trash-2" class="w-4 h-4 text-orange-500"></i>
            Offene Löschanträge
            <span class="ml-auto text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">{{ open_deletions|length }}</span>
        </h3>
        <ul class="space-y-2">
            {% for d in open_deletions %}
            <li class="flex items-center justify-between text-sm">
                <a href="{% url 'dsb:deletion-request-detail' d.pk %}" class="text-blue-600 hover:underline truncate flex-1">
                    {{ d.subject_name|default:"Löschantrag" }}
                </a>
                <span class="ml-2 flex-shrink-0 text-xs px-1.5 py-0.5 rounded bg-orange-100 text-orange-700">
                    {{ d.get_status_display }}
                </span>
            </li>
            {% endfor %}
        </ul>
        <a href="{% url 'dsb:deletion-request-list' %}" class="text-xs text-gray-400 hover:text-blue-600 mt-3 block">Alle anzeigen →</a>
    </div>
    {% endif %}

</div>
{% endif %}

<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8"
     data-testid="dsb-kpi-grid">
    {% stat_card "file-text" "VVT" kpis.vvt_total "blue" kpis.vvt_high_risk "hohes Risiko" %}
    {% stat_card "shield-check" "TOM techn." kpis.tom_tech_total "green" kpis.tom_tech_planned "geplant" %}
    {% stat_card "users" "TOM org." kpis.tom_org_total "green" kpis.tom_org_planned "geplant" %}
    {% stat_card "file-signature" "AVV" kpis.dpa_total "purple" kpis.dpa_expired "abgelaufen" %}
    {% stat_card "search" "Audits" kpis.audits_total "amber" kpis.findings_open "Befunde offen" %}
    {% stat_card "trash-2" "Löschungen" kpis.deletions_total "gray" kpis.deletions_pending "ausstehend" %}
    {% stat_card "alert-triangle" "Pannen" kpis.breaches_total "red" kpis.breaches_open "offen" %}
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 space-y-6">

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                <i data-lucide="file-text" class="w-5 h-5 inline text-blue-500 mr-1"></i>
                Verarbeitungsverzeichnis (Art. 30)
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-900">{{ kpis.vvt_total }}</div>
                    <div class="text-xs text-gray-500">Tätigkeiten</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if kpis.vvt_high_risk %}text-orange-600{% else %}text-gray-400{% endif %}">{{ kpis.vvt_high_risk }}</div>
                    <div class="text-xs text-gray-500">hohes Risiko</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if kpis.vvt_dsfa_required %}text-red-600{% else %}text-gray-400{% endif %}">{{ kpis.vvt_dsfa_required }}</div>
                    <div class="text-xs text-gray-500">DSFA erforderlich</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-900">{{ kpis.third_country_transfers }}</div>
                    <div class="text-xs text-gray-500">Drittlandtransfers</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                <i data-lucide="shield-check" class="w-5 h-5 inline text-green-500 mr-1"></i>
                TOM (Art. 32)
            </h2>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Technisch</h3>
                    <div class="flex items-baseline gap-2">
                        <span class="text-2xl font-bold text-gray-900">{{ kpis.tom_tech_implemented }}</span>
                        <span class="text-sm text-gray-500">/ {{ kpis.tom_tech_total }} umgesetzt</span>
                    </div>
                    {% if kpis.tom_tech_total %}
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: {% widthratio kpis.tom_tech_implemented kpis.tom_tech_total 100 %}%"></div>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Organisatorisch</h3>
                    <div class="flex items-baseline gap-2">
                        <span class="text-2xl font-bold text-gray-900">{{ kpis.tom_org_implemented }}</span>
                        <span class="text-sm text-gray-500">/ {{ kpis.tom_org_total }} umgesetzt</span>
                    </div>
                    {% if kpis.tom_org_total %}
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: {% widthratio kpis.tom_org_implemented kpis.tom_org_total 100 %}%"></div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                <i data-lucide="file-signature" class="w-5 h-5 inline text-purple-500 mr-1"></i>
                AVV (Art. 28)
            </h2>
            <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-900">{{ kpis.dpa_total }}</div>
                    <div class="text-xs text-gray-500">AVV gesamt</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600">{{ kpis.dpa_active }}</div>
                    <div class="text-xs text-gray-500">aktiv</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if kpis.dpa_expired %}text-red-600{% else %}text-gray-400{% endif %}">{{ kpis.dpa_expired }}</div>
                    <div class="text-xs text-gray-500">abgelaufen</div>
                </div>
            </div>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-semibold text-gray-900 mb-3">
                <i data-lucide="search" class="w-4 h-4 inline mr-1"></i>
                Audits
            </h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Geplant</span>
                    <span class="font-medium">{{ kpis.audits_planned }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Abgeschlossen</span>
                    <span class="font-medium text-green-600">{{ kpis.audits_completed }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Offene Befunde</span>
                    <span class="font-medium {% if kpis.findings_open %}text-amber-600{% endif %}">{{ kpis.findings_open }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Kritische Befunde</span>
                    <span class="font-medium {% if kpis.findings_critical %}text-red-600{% endif %}">{{ kpis.findings_critical }}</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-semibold text-gray-900 mb-3">
                <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                Datenpannen (Art. 33)
            </h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Gesamt</span>
                    <span class="font-medium">{{ kpis.breaches_total }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Offen (ungemeldet)</span>
                    <span class="font-medium {% if kpis.breaches_open %}text-amber-600{% endif %}">{{ kpis.breaches_open }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">72h-Frist überschritten</span>
                    <span class="font-medium {% if kpis.breaches_overdue %}text-red-600{% endif %}">{{ kpis.breaches_overdue }}</span>
                </div>
            </div>
        </div>

        <!-- Erfassungsmasken -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-semibold text-gray-900 mb-3">Neu erfassen</h3>
            <div class="space-y-2">
                <a href="{% url 'dsb:vvt-create' %}"
                   class="flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-700 text-sm font-medium rounded-lg hover:bg-blue-100">
                    <i data-lucide="plus" class="w-4 h-4"></i> VVT-Eintrag (Art. 30)
                </a>
                <a href="{% url 'dsb:tom-create' %}?type=tech"
                   class="flex items-center gap-2 px-3 py-2 bg-green-50 text-green-700 text-sm font-medium rounded-lg hover:bg-green-100">
                    <i data-lucide="plus" class="w-4 h-4"></i> Technische Maßnahme
                </a>
                <a href="{% url 'dsb:tom-create' %}?type=org"
                   class="flex items-center gap-2 px-3 py-2 bg-green-50 text-green-700 text-sm font-medium rounded-lg hover:bg-green-100">
                    <i data-lucide="plus" class="w-4 h-4"></i> Org. Maßnahme
                </a>
                <a href="{% url 'dsb:dpa-create' %}"
                   class="flex items-center gap-2 px-3 py-2 bg-purple-50 text-purple-700 text-sm font-medium rounded-lg hover:bg-purple-100">
                    <i data-lucide="plus" class="w-4 h-4"></i> AVV (Art. 28)
                </a>
                <a href="{% url 'dsb:breach-create' %}"
                   class="flex items-center gap-2 px-3 py-2 bg-orange-50 text-orange-700 text-sm font-medium rounded-lg hover:bg-orange-100">
                    <i data-lucide="plus" class="w-4 h-4"></i> Datenpanne (Art. 33)
                </a>
                <a href="{% url 'dsb:deletion-request-create' %}"
                   class="flex items-center gap-2 px-3 py-2 bg-red-50 text-red-700 text-sm font-medium rounded-lg hover:bg-red-100">
                    <i data-lucide="plus" class="w-4 h-4"></i> Löschantrag (Art. 17)
                </a>
                <a href="{% url 'dsb:mandate-create' %}"
                   class="flex items-center gap-2 px-3 py-2 bg-gray-50 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-100">
                    <i data-lucide="plus" class="w-4 h-4"></i> Mandat anlegen
                </a>
            </div>
        </div>

        <!-- Listen -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-semibold text-gray-900 mb-3">Übersichten</h3>
            <div class="space-y-1">
                <a href="{% url 'dsb:vvt-list' %}" class="flex items-center gap-2 text-sm text-gray-700 hover:text-blue-600 py-1">
                    <i data-lucide="file-text" class="w-4 h-4"></i> VVT (Art. 30)
                </a>
                <a href="{% url 'dsb:tom-list' %}" class="flex items-center gap-2 text-sm text-gray-700 hover:text-blue-600 py-1">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> TOM (Art. 32)
                </a>
                <a href="{% url 'dsb:dpa-list' %}" class="flex items-center gap-2 text-sm text-gray-700 hover:text-blue-600 py-1">
                    <i data-lucide="file-signature" class="w-4 h-4"></i> AVV (Art. 28)
                </a>
                <a href="{% url 'dsb:deletion-request-list' %}" class="flex items-center gap-2 text-sm text-gray-700 hover:text-blue-600 py-1">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Löschanträge (Art. 17)
                </a>
                <a href="{% url 'dsb:breach-list' %}" class="flex items-center gap-2 text-sm text-gray-700 hover:text-blue-600 py-1">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i> Datenpannen (Art. 33)
                </a>
                <a href="{% url 'dsb:audit-list' %}" class="flex items-center gap-2 text-sm text-gray-700 hover:text-blue-600 py-1">
                    <i data-lucide="search" class="w-4 h-4"></i> Audits
                </a>
                <a href="{% url 'dsb:mandate-list' %}" class="flex items-center gap-2 text-sm text-gray-700 hover:text-blue-600 py-1">
                    <i data-lucide="building-2" class="w-4 h-4"></i> Mandate
                </a>
                <a href="{% url 'dsb:csv-import' %}" class="flex items-center gap-2 text-sm text-gray-500 hover:text-blue-600 py-1 mt-1 pt-1 border-t">
                    <i data-lucide="upload" class="w-4 h-4"></i> CSV Import
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>lucide.createIcons();</script>
{% endblock %}
