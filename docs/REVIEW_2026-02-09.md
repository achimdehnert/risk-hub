# Risk-Hub Code Review â€” 2026-02-09

## Severity: ğŸ”´ Critical | ğŸŸ  High | ğŸŸ¡ Medium | ğŸ”µ Low

---

## ğŸ”´ 1. BUGS â€” Falsche Feld-Referenzen in `dashboard/services.py`

### 1a. `RiskAssessment` existiert nicht â†’ Import schlÃ¤gt still fehl

**File:** `src/dashboard/services.py:100`

```python
from risk.models import RiskAssessment  # â† FALSCH
```

Das Model heiÃŸt `Assessment`, nicht `RiskAssessment`. Der `try/except`
fÃ¤ngt den `ImportError` ab und setzt `assessments_total = 0`.
**Risikobewertungen werden NIE im Dashboard gezÃ¤hlt.**

Gleicher Bug in `src/approvals/services.py:279`:
```python
from risk.models import RiskAssessment  # â† FALSCH
```

**Fix:** `from risk.models import Assessment`

### 1b. `ActionItem.status` Wert-Mismatch

**File:** `src/dashboard/services.py:147,151`

```python
actions_qs.exclude(status="done")  # â† FALSCH
```

`ActionItem.STATUS_CHOICES` definiert: `open`, `in_progress`,
`completed`, `cancelled` â€” **kein `done`**.
`ProtectionMeasure.Status` hat `done`, aber `ActionItem` hat `completed`.

**Fix:** `status="completed"`

---

## ğŸ”´ 2. SCHEMA-DRIFT â€” Model hat Felder, DB nicht

### 2a. `permissions_permission` â€” 4 Spalten fehlen in DB

| Model-Feld | In DB? |
|------------|--------|
| `module`   | âŒ     |
| `resource` | âŒ     |
| `action`   | âŒ     |
| `is_system`| âŒ     |

**Ursache:** Migration erstellt die Tabelle nur mit `id, code,
description, created_at`. Model definiert 4 weitere Felder.

### 2b. `permissions_role` â€” `description` fehlt in DB

Model hat `description = TextField(...)`, DB hat nur
`id, tenant_id, name, is_system, created_at`.

### 2c. `permissions_role_permission` â€” PK-Typ-Mismatch

Model: `id = UUIDField(primary_key=True)`
DB: `id bigint` (auto-increment)

**Kritisch:** Jede `.create()` mit expliziter UUID-PK wird scheitern.

### 2d. `permissions_override` â€” Tabelle fehlt komplett

Model `PermissionOverride` existiert in Code, aber keine DB-Tabelle.

### 2e. `substances_location_entry` â€” `created_by` fehlt

Model erbt von `TenantScopedModel` (hat `created_by`), aber die
Migration hat das Feld nicht erstellt.

---

## ğŸŸ  3. NAMING CONVENTIONS â€” Inkonsistenzen

### 3a. DB-Tabellennamen: Redundante Dopplungen

ADR-003: `<app>_<entity>`, aber manche wiederholen den App-Namen:

| db_table                     | Besser wÃ¤re              |
|------------------------------|--------------------------|
| `documents_document`         | `documents_doc`          |
| `notifications_notification` | `notifications_item`     |
| `permissions_permission`     | `permissions_perm`       |
| `substances_substance`       | `substances_entry`       |

**PrioritÃ¤t:** Niedrig (breaking change), aber fÃ¼r Dokumentation merken.

### 3b. Inkonsistentes FK-Pattern: ForeignKey vs UUID

Manche User-Referenzen nutzen `ForeignKey(User, ...)`:
- `ApprovalRequest.requested_by` â†’ FK
- `ProtectionMeasure.responsible_user` â†’ FK
- `ExplosionConcept.created_by` â†’ FK

Andere nutzen bare `UUIDField`:
- `ActionItem.assigned_to_id` â†’ UUID
- `AuditEvent.user_id` â†’ UUID
- `Notification.recipient_id` â†’ UUID
- `Assessment.created_by_id` â†’ UUID
- `SdsRevision.approved_by` â†’ UUID
- `ExportJob.requested_by_user_id` â†’ UUID

**Empfehlung:** Einheitlich machen. Loose-coupled UUIDs fÃ¼r
Cross-Module (audit, notifications), ForeignKey fÃ¼r Same-Module.

### 3c. Index-Namen fehlen (14 Stellen)

Auto-generierte Index-Namen sind fragil bei Migrations:

```python
# âŒ Kein Name
models.Index(fields=["tenant_id", "status"])

# âœ… Mit Name
models.Index(fields=["tenant_id", "status"], name="idx_risk_tenant_status")
```

**Betroffene Models:** Assessment, Hazard, ActionItem, ExportJob,
ReferenceStandard, MeasureCatalog, ExplosionConcept, EquipmentType,
Equipment (insgesamt 14 Indexe ohne Namen).

---

## ğŸŸ  4. DOPPELTE DEFINITIONEN

### 4a. `StorageClass` zweimal definiert mit unterschiedlichen Werten

1. `Substance.StorageClass` (Zeile 94): Granular (4.1A, 4.1B, 5.1A...)
2. Standalone `StorageClass` (Zeile 546): Einfach (4.1, 5.1, 6.1...)

`LocationSubstanceEntry.storage_class` nutzt die standalone Version,
`Substance.storage_class` nutzt die innere Version. **Inkompatibel.**

### 4b. `_require_tenant()` dupliziert

Identische Funktion in:
- `src/documents/views.py:18-22`
- `src/risk/views.py:22-28`

**Fix:** Nach `src/common/utils.py` extrahieren.

---

## ğŸŸ  5. URL NAMESPACE KONFLIKT

```
WARNING: URL namespace 'explosionsschutz' isn't unique.
```

Zwei URL-Dateien mit `app_name = "explosionsschutz"`:
- `explosionsschutz/urls.py` (API)
- `explosionsschutz/html_urls.py` (HTML Views)

**Fix:** API-Namespace umbenennen zu `explosionsschutz-api`
(wie bei substances: `substances-api`).

---

## ğŸŸ¡ 6. FEHLENDE `updated_at` FELDER

Models ohne `updated_at` (ADR-003 fordert Audit-Trail):

| Model              | `updated_at` |
|--------------------|:------------:|
| Document           | âŒ           |
| ApprovalWorkflow   | âŒ           |
| Permission         | âŒ           |
| Role               | âŒ           |
| RolePermission     | âŒ           |

---

## ğŸŸ¡ 7. FEHLENDE `__str__` TYPE HINTS

PEP 484: Alle `__str__` in `explosionsschutz/models.py` haben keinen
Return-Type-Hint (`-> str`). Andere Module (risk, actions, audit) haben
ihn korrekt.

---

## ğŸ”µ 8. MINOR STYLE ISSUES

### 8a. Inconsistent Choices Pattern

Manche Models nutzen `TextChoices` (Empfohlen):
```python
class Status(models.TextChoices):
    DRAFT = "draft", "Draft"
```

Andere nutzen klassische Tupel-Listen:
```python
STATUS_CHOICES = [("draft", "Draft"), ...]
```

**Betroffene:** ActionItem, Assessment, Hazard, Document, ExportJob,
RetentionPolicy.

### 8b. `created_by` Feld-Typ inkonsistent

- `TenantScopedModel.created_by` â†’ `UUIDField` (bare)
- `ExplosionConcept.created_by` â†’ `ForeignKey(User, ...)`

---

## ZUSAMMENFASSUNG â€” PrioritÃ¤ten

| # | Severity | Finding | Aufwand |
|---|----------|---------|---------|
| 1a | ğŸ”´ | `RiskAssessment` â†’ `Assessment` | 5 min |
| 1b | ğŸ”´ | `status="done"` â†’ `"completed"` | 2 min |
| 2a-d | ğŸ”´ | Schema-Drift permissions | 30 min |
| 2e | ğŸ”´ | `created_by` fehlt in location_entry | 10 min |
| 3c | ğŸŸ  | 14 Indexe ohne Namen | 20 min |
| 4a | ğŸŸ  | Doppelte StorageClass | 15 min |
| 4b | ğŸŸ  | `_require_tenant` extrahieren | 10 min |
| 5 | ğŸŸ  | URL-Namespace-Konflikt | 5 min |
| 6 | ğŸŸ¡ | Fehlende `updated_at` | 15 min |
| 7 | ğŸŸ¡ | Fehlende Type-Hints | 10 min |
| 8a | ğŸ”µ | TextChoices vereinheitlichen | 20 min |
| 8b | ğŸ”µ | `created_by` Typ-Inkonsistenz | 10 min |
